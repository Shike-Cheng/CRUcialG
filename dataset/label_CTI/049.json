{"doc_key": "049", "sentences": [["Some", "of", "the", "Word", "documents", "discovered", "for", "this", "campaign", "use", "a", "chain", "of", "relationships", "definitions", "to", "load", "embedded", "XLSM", "files", "which", "contain", "the", "actual", "VBA", "code", "that", "will", "download", "the", "payloads", "."], ["Additional", "malicious", "XLSM", "files", "loaded", "during", "runtime", "."], ["The", "maldocs", "are", "Office", "Open", "XML", "documents", "consisting", "of", "two", "key", "relationship", "definition", "files", "-", "the", "main", "one", "called", "``", "AquiTaLimpo.xml.rels", ",", "''", "and", "another", "one", "called", "``", "comments.xml.rels", ",", "''", "which", "will", "load", "the", "embedded", "XLSM", "files", "which", "contain", "the", "VBA", "code", "."], ["Malicious", "relationship", "file", "linking", "to", "the", "embedded", "XLSM", "files", "."], ["When", "the", "Word", "document", "is", "open", ",", "Excel", "is", "also", "loaded", "to", "open", "the", "XLSM", "files", "embedded", "in", "the", "document", "and", "will", "launch", "the", "macro", "to", "download", "the", "payloads", "."], ["PPAM", "files", "are", "add-on", "files", "used", "by", "Microsoft", "PowerPoint", "to", "add", "additional", "functionality", "such", "as", "custom", "macros", ",", "tools", "and", "commands", "."], ["Finally", ",", "the", "infection", "chain", "drops", "a", "popular", "RAT", "that", "can", "be", "njRAT", "or", "AsyncRAT", "."], ["The", "earliest", "infection", "chain", "discovered", "contains", "a", "macro", "that", "downloads", "and", "executes", "a", "remote", "HTA", "file", "from", "an", "attacker-controlled", "location", "."], ["Malicious", "macro", "in", "the", "PPAM", "."], ["Stage", "1A", ":", "Malicious", "HTA"], ["The", "malicious", "HTA", "is", "simply", "an", "escaped", "JavaScript", "snippet", "that", ",", "in", "turn", ",", "executes", "a", "VBScript", "(", "embedded", "in", "an", "HTA", ")", "to", "download", "and", "execute", "the", "next", "stage", "(", "Stage", "#", "2", "PowerShell", "script", ")", "of", "the", "infection", "chain", "."], ["Un-escaped", "VB", "code", "used", "to", "download", "and", "execute", "Stage", "2", "on", "the", "endpoint", "."], ["Stage", "2", ":", "PS1", "Script"], ["The", "powershell", "script", "executed", "on", "the", "endpoint", "is", "the", "de-facto", "instrumentor", "of", "the", "infection", "chain", "."], ["This", "script", "performs", "the", "following", "actions", "on", "the", "endpoint", ":"], ["Change", "the", "current", "user", "'", "s", "Startup", "folders", "to", "those", "specified", "in", "the", "script", "by", "modify", "the", "registry", "values", ":"], ["Create", "a", "custom", "VBS", "(", "Stage", "#", "2A", ")", "in", "this", "modified", "Startup", "directory", "to", "execute", "a", "downloaded", "Powershell", "(", "ps1", ")", "script", "(", "Stage", "#", "3", "e.g", "."], ["``", "msi.ps1", "''", ")", "across", "reboots", "."], ["VBScript", "created", "in", "a", "custom", "Startup", "folder", "to", "run", "a", "ps1", "downloaded", "subsequently", "."], ["The", "script", "will", "then", "check", "for", "the", "presence", "of", "five", "Anti-Virus", "products", "on", "the", "endpoint", "."], ["Based", "on", "the", "AV", "found", "it", "will", "download", "a", "specific", "version", "of", "the", "ps1", "specified", "in", "the", "previous", "step", "(", "Step", "2", "and", "Stage", "3", "\u2014", "msi.ps1", "above", ")", "and", "execute", "the", "VB", "script", "created", "in", "Stage", "2A", "."], ["If", "no", "AV", "products", "are", "found", "on", "the", "endpoint", ",", "the", "script", "will", "perform", "the", "following", "actions", ":"], ["Create", "four", "configuration", "scripts", "on", "the", "endpoint", "."], ["Script", "1", "is", "used", "to", "modify", "the", "``", "windir", "''", "path", "to", "execute", "itself", "when", "a", "user", "or", "application", "accesses", "the", "``", "windir", "''", "environment", "variable", "."], ["The", "script", "also", "runs", "Script", "3", "if", "the", "current", "user", "is", "an", "Administrator", "."], ["Figure", "12", ":", "Modify", "the", "``", "windir", "''", "path", "to", "execute", "itself", "."], ["c.", "Script", "2", "is", "used", "to", "create", "exclusions", "for", "Microsoft", "Defender", "for", "specific", "paths", ",", "executables", "and", "to", "deploy", "a", "specific", ".Net", "framework", ":"], ["Add-MpPreference", "-ExclusionProcess", "powershell.exe"], ["Add-MpPreference", "-ExclusionProcess", "Wscript.exe"], ["d.", "Script", "3", "is", "used", "to", "run", "Script", "2", "."], ["e.", "Script", "4", "is", "used", "to", "run", "Script", "1", "."], ["f.", "Execute", "Script", "4", "on", "the", "endpoint", "."], ["g.", "Finally", ",", "the", "parent", "ps1", "script", "will", "download", "another", "version", "of", "the", "Stage", "4", "script", "and", "execute", "it", "via", "the", "Stage", "2A", "VB", "script", "."], ["h.", "Once", "the", "configuration", "scripts", "have", "completed", "execution", ",", "they", "are", "deleted", "from", "the", "endpoint", "."], ["Hexlified", "injector", "DLL", ":", "This", "DLL", "is", "used", "to", "run", "a", "specified", "process", "and", "inject", "the", "accompanying", "malware", "into", "it", "."], ["Base64-encoded", "or", "plaintext", "command", "to", "reflective", "load", "the", "injector", "DLL", "into", "the", "powershell", "process", "with", "the", "target", "process", "'", "image", "path", "and", "malware", "payload", "bytes", "passed", "as", "an", "argument", "to", "the", "injector", "."], ["[", "Reflection.Assembly", "]", ":", ":Load", "(", "$", "H5", ")", ".GetType", "(", "'VBNET.PE", "'", ")", ".GetMethod", "(", "'Run", "'", ")", ".Invoke", "(", "$", "null", ",", "[", "object", "[", "]", "]", "(", "'", "C", ":", "\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\aspnet_compiler.exe", "'", ",", "$", "H1", ")", ")"], ["We", "have", "also", "observed", "minor", "variations", "in", "the", "infection", "chains", "where", "some", "of", "the", "(", "mini", ")", "scripts", "used", "in", "Stage", "2", "are", "hosted", "independently", ",", "downloaded", "and", "executed", "during", "the", "infection", "process", "."], ["The", "executables", "accompanying", "the", "Stage", "3", "PowerShell", "script", "consist", "of", ":"], ["Injector", "DLL", ":", "This", "DLL", "accepts", "two", "arguments", ":"], ["Malware", "payload", "bytes", "to", "be", "injected", "into", "the", "hollowed", "out", "target", "process", "."], ["Malware", "payload", ":", "The", "actual", "malware", "payload", "to", "be", "deployed", "on", "the", "endpoint", "."], ["The", "DLL", "is", "a", "simple", "injector", "based", "on", ".NET", "."], ["The", "DLL", "is", "usually", "obfuscated", "with", ".NET", "Reactor", "which", "can", "be", "easily", "deobfuscated", "using", "de4dot", "."], ["There", "is", "only", "one", "exported", "method", "that", "takes", "the", "two", "arguments", "mentioned", "above", "and", "deploys", "the", "malware", "payload", "into", "the", "target", "process", "."], ["If", "any", "error", "occurs", "during", "the", "injection", "it", "will", "kill", "the", "target", "process", "and", "retry", "five", "times", "before", "giving", "up", "."], ["Interestingly", ",", "the", "DLL", "which", "is", "a", "modified", "version", "of", "RunPE", ",", "also", "contains", "code", "to", "change", "ACL", "to", "kernel", "objects", ",", "which", "is", "never", "called", ",", "indicating", "either", "a", "work-in-progress", "or", "redundant", "code", "borrowed", "from", "somewhere", "else", "but", "never", "used", "."]], "ner": [[[3, 4, "MF"], [8, 8, "MP"], [18, 19, "MF"], [24, 25, "MF"], [30, 30, "MF"]], [[34, 35, "MF"]], [[41, 41, "MF"], [43, 46, "MF"], [60, 60, "MF"], [68, 68, "MF"], [76, 77, "MF"], [81, 82, "MF"]], [[85, 86, "MF"], [91, 92, "MF"]], [[96, 97, "MF"], [101, 101, "MP"], [108, 109, "MF"], [118, 118, "MF"], [122, 122, "MF"]], [[124, 125, "MF"], [131, 132, "MP"], [139, 140, "TP"], [142, 142, "TP"], [144, 144, "TP"]], [[149, 150, "MP"], [154, 154, "MF"], [158, 158, "MF"], [160, 160, "MF"]], [[164, 165, "MP"], [169, 169, "MF"], [176, 177, "MF"], [180, 181, "SO"]], [[184, 184, "MF"], [187, 187, "MP"]], [[193, 193, "MP"]], [[196, 196, "MP"], [201, 202, "MP"], [210, 210, "MF"], [228, 229, "MF"], [233, 234, "MP"]], [[237, 238, "MF"]], [[253, 254, "MP"]], [[256, 257, "MP"], [264, 265, "MP"]], [[272, 272, "MP"]], [[287, 288, "SF"], [298, 299, "SF"]], [[304, 304, "MF"], [319, 323, "MF"]], [[331, 331, "MF"]], [[337, 337, "MF"], [341, 343, "MF"], [347, 347, "MF"]], [[352, 352, "MP"], [365, 365, "SO"]], [[372, 372, "MP"], [380, 380, "MF"], [393, 393, "MF"], [399, 400, "MF"]], [[414, 414, "SO"], [417, 417, "MP"]], [[426, 427, "MF"]], [[432, 432, "MF"], [440, 440, "SF"], [454, 454, "SF"]], [[460, 460, "MP"], [463, 463, "MF"]], [[479, 479, "MF"]], [[487, 487, "MP"], [493, 493, "MF"], [495, 496, "TP"], [501, 501, "MP"]], [[512, 512, "TF"]], [[515, 515, "TF"]], [[517, 518, "MP"], [523, 524, "MF"]], [[527, 528, "MP"], [533, 534, "MF"]], [[538, 539, "MF"], [542, 542, "SO"]], [[549, 550, "MP"], [557, 559, "MF"], [562, 562, "MF"], [567, 568, "MP"]], [[573, 574, "MF"], [584, 584, "SO"]], [[586, 588, "MF"], [591, 591, "MF"], [598, 598, "MP"], [603, 603, "MP"]], [[607, 607, "MP"], [609, 610, "MP"], [615, 616, "MF"], [619, 620, "MP"], [623, 627, "TF"], [629, 631, "MF"]], [[651, 651, "MF"], [671, 673, "MF"]], [[688, 689, "MP"], [697, 697, "MF"]], [[715, 715, "MP"], [720, 721, "MF"]], [[725, 726, "MP"]], [[734, 735, "MF"]], [[747, 748, "MF"]], [[762, 762, "MF"]], [[772, 772, "MF"], [777, 778, "MP"]], [[803, 804, "MF"], [807, 808, "MP"]], [[816, 816, "MP"], [817, 817, "MP"], [821, 822, "MP"]], [[834, 834, "MF"], [841, 841, "MF"], [845, 845, "MF"]]], "relations": [[[8, 8, 3, 4, "WR"], [8, 8, 18, 19, "RD"], [8, 8, 24, 25, "EX"], [8, 8, 30, 30, "WR"], [8, 8, 41, 41, "WR"], [8, 8, 43, 46, "WR"], [8, 8, 60, 60, "WR"], [8, 8, 68, 68, "WR"], [8, 8, 85, 86, "WR"], [8, 8, 96, 97, "WR"]], [[34, 35, 76, 77, "CO"], [34, 35, 18, 19, "CO"], [34, 35, 91, 92, "CO"]], [[81, 82, 24, 25, "CO"]], [], [[101, 101, 41, 41, "WR"], [101, 101, 43, 46, "WR"], [101, 101, 60, 60, "WR"], [101, 101, 68, 68, "WR"], [101, 101, 81, 82, "WR"], [101, 101, 85, 86, "WR"], [101, 101, 91, 92, "WR"], [101, 101, 96, 97, "WR"], [101, 101, 108, 109, "RD"], [101, 101, 118, 118, "EX"], [101, 101, 122, 122, "WR"]], [[131, 132, 124, 125, "WR"], [131, 132, 139, 140, "FR"], [131, 132, 142, 142, "FR"], [131, 132, 144, 144, "FR"]], [[149, 150, 154, 154, "WR"], [158, 158, 154, 154, "CO"], [158, 158, 160, 160, "CO"]], [[164, 165, 158, 158, "WR"], [164, 165, 160, 160, "WR"], [164, 165, 169, 169, "WR"], [164, 165, 176, 177, "WR"], [164, 165, 176, 177, "EX"], [164, 165, 180, 181, "ST"], [164, 165, 180, 181, "RF"]], [[187, 187, 184, 184, "WR"], [187, 187, 184, 184, "WR"], [187, 187, 237, 238, "WR"], [184, 184, 169, 169, "CO"]], [[193, 193, 201, 202, "CO"], [193, 193, 196, 196, "CO"]], [[196, 196, 210, 210, "EX"], [196, 196, 228, 229, "WR"], [196, 196, 228, 229, "EX"], [233, 234, 228, 229, "RD"], [233, 234, 237, 238, "WR"], [233, 234, 237, 238, "WR"]], [], [[253, 254, 264, 265, "CO"], [253, 254, 256, 257, "CO"]], [], [[272, 272, 287, 288, "RD"], [272, 272, 237, 238, "WR"], [272, 272, 298, 299, "RD"], [272, 272, 287, 288, "WR"], [272, 272, 298, 299, "WR"], [272, 272, 304, 304, "WR"], [272, 272, 319, 323, "EX"], [272, 272, 331, 331, "WR"], [272, 272, 337, 337, "WR"], [272, 272, 341, 343, "WR"], [272, 272, 347, 347, "EX"]], [], [], [[331, 331, 347, 347, "CO"]], [], [[352, 352, 341, 343, "WR"], [352, 352, 365, 365, "ST"], [352, 352, 365, 365, "RF"], [352, 352, 372, 372, "CO"], [365, 365, 414, 414, "CO"]], [[372, 372, 380, 380, "WR"], [372, 372, 393, 393, "WR"], [372, 372, 399, 400, "EX"]], [[417, 417, 414, 414, "ST"], [417, 417, 414, 414, "RF"], [417, 417, 426, 427, "WR"], [417, 417, 440, 440, "RD"], [417, 417, 432, 432, "WR"], [417, 417, 440, 440, "WR"], [417, 417, 463, 463, "EX"], [417, 417, 479, 479, "WR"], [417, 417, 460, 460, "CO"]], [], [[454, 454, 440, 440, "CO"]], [[463, 463, 454, 454, "RD"], [463, 463, 454, 454, "WR"]], [], [[487, 487, 479, 479, "WR"], [487, 487, 493, 493, "WR"], [495, 496, 493, 493, "RD"], [495, 496, 493, 493, "EX"], [495, 496, 501, 501, "FR"], [487, 487, 512, 512, "WR"], [487, 487, 515, 515, "WR"]], [], [], [[517, 518, 523, 524, "EX"]], [[527, 528, 533, 534, "EX"], [527, 528, 538, 539, "WR"], [527, 528, 542, 542, "ST"], [527, 528, 542, 542, "RF"]], [], [[549, 550, 538, 539, "WR"], [549, 550, 542, 542, "ST"], [549, 550, 542, 542, "RF"], [549, 550, 557, 559, "WR"], [549, 550, 567, 568, "FR"], [567, 568, 562, 562, "EX"], [567, 568, 573, 574, "WR"], [567, 568, 584, 584, "ST"], [567, 568, 584, 584, "RF"], [557, 559, 562, 562, "CO"]], [], [[598, 598, 573, 574, "WR"], [598, 598, 584, 584, "ST"], [598, 598, 584, 584, "RF"], [598, 598, 586, 588, "EX"], [598, 598, 591, 591, "EX"], [598, 598, 603, 603, "IJ"], [586, 588, 591, 591, "CO"]], [[607, 607, 615, 616, "RD"], [609, 610, 615, 616, "RD"], [607, 607, 619, 620, "IJ"], [607, 607, 623, 627, "WR"], [607, 607, 629, 631, "WR"], [619, 620, 651, 651, "WR"], [619, 620, 671, 673, "WR"]], [], [[688, 689, 651, 651, "WR"], [688, 689, 671, 673, "WR"], [688, 689, 697, 697, "WR"], [688, 689, 697, 697, "EX"]], [[715, 715, 720, 721, "WR"], [715, 715, 725, 726, "FR"]], [[725, 726, 734, 735, "RD"], [725, 726, 747, 748, "RD"], [725, 726, 762, 762, "WR"]], [], [], [[762, 762, 772, 772, "CO"]], [[777, 778, 772, 772, "WR"], [777, 778, 803, 804, "WR"]], [[807, 808, 803, 804, "WR"], [807, 808, 803, 804, "WR"], [807, 808, 821, 822, "CO"]], [[817, 817, 821, 822, "UK"], [816, 816, 817, 817, "CO"]], []]}