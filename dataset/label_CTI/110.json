{"doc_key": "110", "sentences": [["If", "an", "attacker", "can", "get", "one", "of", "those", "major", "advertisement", "networks", "to", "display", "an", "advertisement", "with", "a", "malicious", "payload", "just", "for", "a", "few", "minutes", "without", "being", "detected", ",", "then", "countless", "machines", "can", "be", "infected", "by", "such", "an", "attack", "."], ["``", "Attack", "in", "a", "NutshellThe", "attack", "has", "a", "lot", "of", "variations", ",", "but", "always", "follows", "these", "steps", ":", "You", "visit", "a", "website", "with", "the", "malicious", "advertisementYou", "get", "redirected", "to", "a", "different", "website", "that", "redirects", "you", "based", "on", "user", "agent", "."], ["We", "observed", "that", "Windows", "and", "Mac", "users", "get", "redirected", "to", "different", "malware", "in", "order", "to", "infect", "both", "operating", "systemsThe", "final", "page", "starts", "the", "download", "of", "a", "malicious", "fileExample", "Attack", "SequenceOnce", "the", "victim", "gets", "redirected", "to", "the", "final", "URL", ",", "the", "website", "automatically", "starts", "the", "download", "of", "a", "unique", "piece", "of", "malware", "for", "every", "user", "."], ["The", "file", "is", "a", "bundle", "of", "legitimate", "software", ",", "like", "a", "media-player", ",", "and", "compiles", "malware", "and", "a", "unique-to-every-user", "configuration", "into", "the", "downloaded", "file", "."], ["The", "attackers", "are", "purely", "relying", "on", "social", "engineering", "techniques", ",", "in", "order", "to", "get", "the", "user", "to", "install", "the", "software", "package", "."], ["Observed", "connections", "to", "the", "``", "Kyle", "and", "Stan", "''", "Network", "on", "a", "log", "scale", "."], ["All", "the", "domains", "directly", "associated", "to", "the", "attackers", "are", "hosted", "by", "amazon", "and", "use", "a", "whois", "privacy", "protection", "service", "to", "keep", "the", "identity", "protected", "(", "e.", "g.", "amazon.co2m", "@", "amazon.co3m", ")", "."], ["Reversing", "of", "the", "Mac", "MalwareBrowser", "Hijacker", "VSearchThe", "Mac", "OS", "Malware", "is", "the", "legitimate", "application", "MPlayerX", "bundled", "with", "two", "well-known", "adware/browser", "hijackers", ":", "Conduit", "and", "VSearch", "."], ["Talos", "reversed", "two", "samples", "of", "this", "malware", ":", "Sample", "1MD5", ":", "537a3542c238877629b24195ab8e4ab4SHA-256", ":", "8A9CD910DE0349A1FD67D535E7AB6815E30544DD77D479A07932ECCB3F56E66ESample", "2MD5", ":", "0F055F734D211C699A0E9A3418B73514SHA-256", ":", "89A6827698BDFF134A2400EE5DB7E4B17256693A27107166EBA973E5B340D8CF", "The", "hashes", "are", "different", "due", "to", "the", "way", "the", "each", "DMG", "file", "was", "constructed", "."], ["The", "user", "has", "the", "option", "to", "install", "Conduit", "."], ["The", "VSearch", "installation", "is", "not", "optional", "."], ["Here", "is", "the", "command", "that", "is", "used", ":", "MPlayerX.app/Contents/Resources/VSInstaller.app/Contents/MacOS/VSInstallerauth", "13", "agreetolicensThe", "Vsearch", "installer", "downloads", "an", "updated", "version", "and", "installs", "the", "files", "."], ["The", "following", "files", "are", "created", ":", "VSearchAgent.app", "/Library/Application", "Support/VSearch/AgentVSearchPlugIn.bundle", "/System/Library/Frameworks/VSamazon.co6amework/Versions/A/VsearchLoader.bundleDP.plistlibVSearchLoader.dyliblibVSearchLoader.dylib", "Vsearch", "PersistenceA", "launcher", "is", "added", "to", "maintain", "persistence", "between", "reboots", "."], ["The", "following", "commands", "are", "used", "to", "add", "the", "launcher", ":", "/bin/launchctl", "load", "-F", "/Library/LaunchDaemons/amazon.co7ist/bin/launchctl", "start", "com.vsearch.daemonURL", "RequestsThe", "following", "GET", "requests", "are", "made", "to", "'amazon.co8fo", "'", "to", "download", "and", "install", "Vsearch", "."], ["The", "dropper", "is", "a", "32", "bit", "executable", "written", "in", "C++", "."], ["MD5", ":", "602c94e82c83bbaea1abdea420e0b939SHA-256", ":", "ee87af42dda91f6ed6ccedcd20736cb1d00a96f26138c0c6698c9837c1525dee", "The", "GET", "request", "is", "at", "first", "glance", "a", "seemingly", "random", "URI", "and", "begins", "the", "installation", "of", "several", "common", "Spyware/Adware", "applications", "."], ["The", "adware", "bundle", "locations", "are", "retrieved", "in", "the", "server", "response", "and", "later", "executed", "."], ["The", "installer", "window", "presented", "to", "the", "user", "after", "it", "``", "checks", "your", "system", "''", "The", "initial", "GET", "request", "sent", "upon", "execution", "."], ["Followed", "by", "the", "response", "with", "what", "the", "dropper", "should", "downloadThe", "initial", "dropper", "uses", "a", "sophisticated", "technique", "called", "``", "Dynamic", "Forking", "''", "also", "known", "as", "``", "Process", "Hollowing", "''", "."], ["Dynamic", "forking", ",", "is", "a", "technique", "that", "allows", "to", "execute", "an", "image", "within", "another", "process", "'s", "address", "space", "."], ["Create", "a", "SUSPENDED", "ProcessCreate", "the", "host", "process", "(", "this", "dropper", ")", "again", ",", "but", "in", "a", "SUSPENDED", "state2", "."], ["Get", "Thread", "ContextObtain", "the", "thread", "context", "of", "the", "new", "process", "using", "GetThreadContext", "(", ")", "CONTEXT-", ">", "EAX", "points", "to", "what", "will", "be", "the", "entry", "point", "of", "the", "executableCONTEXT-", ">", "EBX", "points", "to", "the", "PEB", "3", "."], ["Get", "Base", "Address", "of", "Child", "ExecutableGet", "the", "base", "address", "of", "the", "new", "executable", "using", "the", "PEB", "(", "[", "ebx", "+", "8", "]", ")", "4", "."], ["Read", "[", "and", "Decrypt", "]", "New", "Executable", "into", "MemoryThis", "particular", "sample", "stores", "the", "child", "executable", "encrypted", "in", "the", "resource", "section", "."], ["It", "uses", "and", "XOR", "decryption", "routine", "with", "this", "key", ":", "It", "uses", "that", "key", "with", "the", "following", "pseudocode", ":", "Other", "samples", "that", "I", "found", "use", "the", "same", "routine", "but", "with", "a", "different", "key", "."], ["For", "example", ",", "one", "of", "the", "encoded", "buffers", "is", "located", "in", "the", "static", "dropper", ".rsrc", "section", "."], ["Notice", "that", "this", "decodes", "to", "the", "file", "magic", "of", "a", "PE32", ":", "This", "decoded", "buffer", "is", "then", "saved", "and", "stored", "for", "later", "."], ["Unmap", "the", "Image", ",", "Reallocate", "Space", ",", "&", "Write", "the", "New", "ExecutableIf", "the", "decoded/new", "executable", "doesn", "'", "t", "have", "the", "same", "base", "address", "or", "is", "a", "larger", "size", "than", "the", "host", "process", ",", "unmap", "the", "host", "process", "'", "s", "image", "using", "ZwUnmapViewOfSection", "and", "re-allocate", "that", "space", "."], ["Set", "Thread", "Context", "and", "ResumeWrite", "the", "new", "entry", "point", "to", "EAX", "(", "in", "the", "CONTEXT", "structure", "obtained", "earlier", ")", "."], ["Afterwards", ",", "use", "SetThreadContext", "(", ")", "to", "apply", "the", "changes", "using", "the", "modified", "CONTEXT", "structure", "."], ["Attaching", "to", "the", "Child", "ExecutableIn", "order", "to", "debug", "the", "child", "executable", ",", "a", "little", "math", "is", "needed", "."], ["You", "have", "(", "at", "least", ")", "two", "options", ",", "both", "require", "determining", "what", "bytes", "will", "be", "copied", "to", "the", "Entry", "Point", "(", "EP", ")", "of", "the", "child", "executable", "before", "the", "thread", "is", "resumed", "."], ["Set", "the", "EP", "bytes", "to", "CC", "(", "int", "3", ")", "and", "set", "your", "Just-in-Time", "Debugger", "to", "catch", "the", "exception", "."], ["Set", "the", "EP", "bytes", "to", "an", "infinite", "loop", "(", "EB", "FE", ")", "and", "just", "allow", "the", "parent", "process", "to", "gracefully", "exit", "before", "attaching", "."], ["The", "EP", "of", "the", "child", "will", "be", "EAX", "in", "the", "CONTEXT", "structure", "set", "in", "the", "child", "executable", "using", "SetThreadContext", "(", ")", "."], ["Since", "we", "also", "know", "where", "the", "bytes", "that", "occupy", "that", "space", "come", "from", "(", "the", "decryption", "routine", "from", "earlier", ")", ",", "simply", "get", "the", "offset", "of", "EAX", "from", "the", "base", "address", "of", "the", "child", "executable", "and", "add", "that", "to", "the", "base", "address", "of", "the", "memory", "that", "is", "copied", "there", ":", "Once", "the", "process", "has", "resumed", ",", "the", "child", "process", "should", "be", "executing", "at", "around", "100", "%", "of", "CPU", "time", "."], ["Replace", "the", "original", "bytes", "and", "continue", "on", "."], ["Intercepting", "the", "GET", "Request", "Construction", "with", "JavaScript", "InjectionAfter", "the", "first", "installation", "screen", ",", "a", "child", "process", "is", "spawned", ",", "which", "then", "creates", "a", "window", "containing", "a", "message", "claiming", "to", "check", "the", "system", ",", "while", "also", "utilizing", "hidden", "web", "browser", "functionality", "."], ["This", "window", "loads", "an", "HTML", "file", "containing", "6,900", "lines", "of", "obfuscated", "JavaScript", "."], ["The", "file", "is", "located", "in", "the", "child", "executable", "statically", ",", "but", "it", "does", "not", "run", "on", "its", "own", ",", "the", "JavaScript", "is", "called", "from", "elsewhere", "in", "the", "binary", "."], ["Determining", "if", "the", "JavaScript", "in", "the", "static", "executable", "is", "the", "same", "Script", "that", "is", "eventually", "gets", "executed", ",", "can", "be", "accomplished", "by", "injecting", "custom", "JavaScript", "."], ["Note", "that", "I", "had", "to", "delay", "the", "execution", "of", "the", "JavaScript", "so", "that", "the", "entire", "page", "was", "loaded", "."], ["Click", "the", "OK", "button", "and", "a", "new", "window", "should", "pop", "up", "containing", "the", "full", "HTML", "document", "used", "in", "this", "embedded", "window", ":", ")", "It", "is", "indeed", "the", "same", "JavaScript", "from", "the", "static", "child", "executable", "."], ["Plus", ",", "it", "keeps", "the", "JavaScript", "section", "the", "exact", "same", "size", "(", "make", "sure", "to", "zero", "out", "any", "unused", "bytes", "that", "occupy", "the", "leftover", "space", "in", "this", "function", "to", "avoid", "an", "exception", ")", "."], ["Search", "for", "the", "location", "in", "memory", "and", "overwrite", "it", "with", "a", "helpful", "alert", "box", "."], ["It", "is", "now", "clear", "how", "the", "GET", "request", "is", "generated", "locally", "using", "CryptoJS", "'", "AES", "w/", "CBC", "functionality", "."], ["The", "URI", "is", "successfully", "decrypted", "and", "displayed", "."], ["The", "large", "number", "of", "domains", "allows", "the", "attackers", "to", "use", "a", "certain", "domain", "just", "for", "a", "very", "short", "time", ",", "burn", "it", "and", "move", "on", "to", "use", "another", "one", "for", "future", "attacks", "."]], "ner": [[[2, 2, "MP"], [9, 10, "SO"], [14, 14, "TF"], [16, 18, "MF"], [30, 30, "TP"]], [[57, 57, "TP"], [64, 64, "TP"]], [[82, 85, "TP"], [82, 85, "TP"], [90, 90, "MP"], [105, 106, "MF"], [109, 110, "TP"], [115, 116, "SO"], [119, 119, "SO"], [127, 129, "MF"], [132, 132, "TP"]], [[135, 135, "MF"], [140, 141, "TF"], [145, 145, "TF"], [149, 149, "MF"], [152, 153, "SF"], [156, 157, "MF"]], [[160, 160, "MP"], [174, 174, "TP"], [178, 179, "MF"]], [], [[198, 198, "SO"], [203, 203, "MP"]], [[235, 237, "MF"], [242, 242, "TF"], [250, 250, "TF"], [252, 252, "TF"]], [[257, 257, "MF"], [260, 260, "MP"], [262, 262, "MF"]], [[289, 289, "TP"], [295, 295, "TF"]], [[298, 298, "TF"]], [], [[328, 328, "TF"], [338, 338, "TF"]], [[355, 355, "TF"], [376, 376, "TF"]], [[379, 379, "MF"]], [[412, 413, "MF"]], [[416, 417, "MF"]], [[435, 435, "TP"]], [[458, 458, "MF"], [462, 462, "MP"], [468, 471, "MP"], [475, 478, "MP"]], [[480, 481, "MP"]], [[504, 505, "MP"], [508, 508, "MF"]], [[526, 527, "MP"]], [[566, 566, "MF"]], [[585, 585, "MF"], [592, 593, "MF"]], [[600, 600, "MP"], [603, 605, "TP"], [608, 608, "TF"], [610, 610, "MP"], [613, 613, "TF"], [627, 627, "TP"], [632, 632, "TF"]], [[647, 647, "MF"]], [[661, 661, "MF"]], [[685, 685, "MF"], [688, 688, "MF"]], [[722, 722, "MP"]], [], [[766, 767, "MF"]], [[801, 802, "MF"], [805, 805, "MP"]], [], [[845, 846, "MP"]], [[857, 857, "MF"], [868, 869, "MF"]], [[908, 909, "MF"]], [], [[959, 959, "TF"], [967, 968, "MP"], [976, 976, "MF"], [979, 979, "MF"], [984, 984, "SF"], [990, 991, "SF"]], [[995, 995, "MP"], [998, 999, "MF"], [1005, 1005, "MF"]], [[1008, 1008, "MF"], [1013, 1014, "MF"], [1018, 1018, "MF"], [1027, 1027, "MF"]], [[1039, 1039, "MF"], [1043, 1043, "MF"], [1047, 1047, "MF"], [1060, 1060, "MF"]], [[1064, 1064, "MP"], [1072, 1072, "MF"], [1077, 1077, "MF"]], [[1088, 1088, "MF"], [1095, 1096, "MF"], [1104, 1104, "MF"], [1109, 1109, "MF"], [1114, 1114, "MF"]], [[1118, 1118, "MP"], [1121, 1121, "MF"]], [[1155, 1155, "SF"], [1158, 1158, "MF"]], [], [], [[1196, 1196, "SO"], [1199, 1199, "MP"], [1204, 1204, "SO"], [1213, 1213, "SO"], [1220, 1220, "SO"]]], "relations": [[[2, 2, 9, 10, "ST"], [2, 2, 9, 10, "RF"], [2, 2, 14, 14, "WR"], [2, 2, 16, 18, "WR"], [30, 30, 16, 18, "WR"], [30, 30, 16, 18, "WR"], [30, 30, 90, 90, "FR"], [2, 2, 160, 160, "CO"], [2, 2, 1199, 1199, "CO"]], [[57, 57, 16, 18, "WR"], [57, 57, 64, 64, "CO"]], [[82, 85, 16, 18, "WR"], [82, 85, 90, 90, "RF"], [82, 85, 90, 90, "ST"], [90, 90, 105, 106, "WR"], [109, 110, 105, 106, "WR"], [109, 110, 115, 116, "ST"], [109, 110, 115, 116, "RF"], [109, 110, 152, 153, "RD"], [109, 110, 152, 153, "RD"], [109, 110, 152, 153, "WR"], [115, 116, 119, 119, "CO"], [109, 110, 132, 132, "CO"], [127, 129, 149, 149, "CO"], [82, 85, 82, 85, "CO"]], [[140, 141, 145, 145, "CO"], [135, 135, 156, 157, "CO"]], [[160, 160, 152, 153, "RD"], [160, 160, 152, 153, "RD"], [160, 160, 152, 153, "WR"], [160, 160, 174, 174, "FR"], [174, 174, 178, 179, "EX"], [174, 174, 235, 237, "RD"], [174, 174, 235, 237, "WR"], [174, 174, 235, 237, "EX"], [174, 174, 257, 257, "RD"], [174, 174, 257, 257, "WR"], [174, 174, 257, 257, "EX"], [160, 160, 203, 203, "CO"]], [], [[203, 203, 198, 198, "ST"], [203, 203, 198, 198, "RF"]], [[250, 250, 295, 295, "CO"], [252, 252, 298, 298, "CO"], [252, 252, 376, 376, "CO"]], [[260, 260, 235, 237, "WR"], [260, 260, 257, 257, "WR"], [260, 260, 257, 257, "WR"], [260, 260, 262, 262, "WR"], [260, 260, 262, 262, "WR"]], [[289, 289, 262, 262, "WR"], [289, 289, 262, 262, "WR"], [289, 289, 379, 379, "WR"], [289, 289, 379, 379, "WR"], [289, 289, 412, 413, "WR"], [289, 289, 416, 417, "WR"], [289, 289, 435, 435, "CO"]], [], [], [[338, 338, 355, 355, "CO"]], [], [], [], [], [[435, 435, 379, 379, "WR"], [435, 435, 412, 413, "WR"], [435, 435, 416, 417, "WR"], [435, 435, 416, 417, "WR"], [435, 435, 458, 458, "WR"]], [[462, 462, 458, 458, "EX"], [462, 462, 468, 471, "FR"], [468, 471, 475, 478, "CO"], [468, 471, 480, 481, "CO"]], [], [[504, 505, 508, 508, "WR"], [504, 505, 526, 527, "FR"]], [[526, 527, 508, 508, "WR"], [526, 527, 592, 593, "WR"], [526, 527, 647, 647, "WR"], [526, 527, 661, 661, "WR"]], [[566, 566, 585, 585, "CO"]], [], [[600, 600, 610, 610, "CO"], [608, 608, 613, 613, "CO"], [603, 605, 627, 627, "CO"]], [], [], [[685, 685, 688, 688, "CO"]], [[722, 722, 805, 805, "CO"]], [], [[766, 767, 801, 802, "CO"]], [], [], [[845, 846, 592, 593, "WR"], [845, 846, 647, 647, "WR"], [845, 846, 661, 661, "WR"], [845, 846, 661, 661, "WR"], [845, 846, 857, 857, "WR"], [845, 846, 857, 857, "WR"]], [[857, 857, 868, 869, "CO"], [857, 857, 908, 909, "CO"]], [], [], [[967, 968, 908, 909, "WR"], [967, 968, 976, 976, "WR"], [967, 968, 984, 984, "RD"], [967, 968, 990, 991, "RD"], [967, 968, 990, 991, "RD"], [967, 968, 990, 991, "WR"], [976, 976, 979, 979, "CO"]], [[995, 995, 976, 976, "EX"], [995, 995, 998, 999, "EX"], [995, 995, 1013, 1014, "WR"], [995, 995, 1047, 1047, "WR"], [998, 999, 1008, 1008, "CO"], [998, 999, 1018, 1018, "CO"], [1005, 1005, 1027, 1027, "CO"], [1005, 1005, 1039, 1039, "CO"], [1005, 1005, 1109, 1109, "CO"]], [], [[1043, 1043, 1114, 1114, "CO"], [1047, 1047, 1060, 1060, "CO"]], [[1064, 1064, 1013, 1014, "WR"], [1064, 1064, 1060, 1060, "WR"], [1064, 1064, 1072, 1072, "EX"], [1064, 1064, 1077, 1077, "WR"], [1064, 1064, 1088, 1088, "WR"]], [[1095, 1096, 1104, 1104, "CO"]], [[1118, 1118, 1077, 1077, "WR"], [1118, 1118, 1088, 1088, "WR"], [1118, 1118, 1088, 1088, "WR"], [1118, 1118, 1121, 1121, "WR"], [1118, 1118, 1121, 1121, "WR"], [1118, 1118, 1155, 1155, "RD"], [1118, 1118, 1155, 1155, "RD"], [1118, 1118, 1155, 1155, "WR"], [1118, 1118, 1158, 1158, "WR"], [1118, 1118, 1196, 1196, "ST"], [1118, 1118, 1196, 1196, "RF"]], [[1158, 1158, 1155, 1155, "RD"], [1158, 1158, 1155, 1155, "WR"]], [], [], [[1199, 1199, 1121, 1121, "WR"], [1199, 1199, 1158, 1158, "WR"], [1199, 1199, 1196, 1196, "ST"], [1199, 1199, 1196, 1196, "RF"], [1199, 1199, 1204, 1204, "ST"], [1199, 1199, 1204, 1204, "RF"], [1204, 1204, 1213, 1213, "CO"]]]}